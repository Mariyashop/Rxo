<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گردونه شانس</title>
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-yWTO8mvT+0GKZ+4Zywx2ZxFTHvTb8U9VZ0A7FFBdb7xQ0uLbD6JQd3U3Fj5i2Z+x9Ky6nB44UQ5T0tD+3vTzYw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
    <script src="https://kit.fontawesome.com/4a4d988ce9.js" crossorigin="anonymous"></script>
    <style>
        canvas {
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 font-['Vazirmatn']">
    <!-- منوی ناوبری -->
    <nav class="bg-white dark:bg-gray-900 fixed w-full z-20 top-0 start-0 border-b border-gray-200 dark:border-gray-600 md:hidden">
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
            <a href="/index.html" class="flex items-center space-x-3 rtl:space-x-reverse">
                <img src="https://yt3.googleusercontent.com/fVFrfFds5nFiY7ESdi5hFcgLRkgppaRK8Pab1EZpQrD9Fx13r224gpY8dQAVlt9j59sxwYgG-Q=s900-c-k-c0x00ffffff-no-rj" class="h-8" alt="Flowbite Logo">
                <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">Mariya Shop</span>
            </a>
            <a href="https://www.youtube.com/@MariyaRxo">
                <div class="flex md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse">
                    <button type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2 text-center dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">استریم یوتیوب</button>
                </div>
            </a>
        </div>
    </nav>
    <div class="fixed bottom-0 left-0 z-50 w-full h-16 bg-white border-t border-gray-200 dark:bg-gray-700 dark:border-gray-600 md:hidden">
        <div class="flex h-full items-center justify-center mx-auto font-medium">
            <button type="button" class="inline-flex flex-col items-center justify-center px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 group">
                <svg class="w-5 h-5 mb-1 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
                </svg>
                <a href="/index.html"><span class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">فروشگاه</span></a>
            </button>
            <button type="button" class="inline-flex flex-col items-center justify-center px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 group">
                <a href="https://www.youtube.com/@MariyaRxo"><i class="fa-brands fa-youtube fa-2xl" style="color: #ff0000;"></i></a>
            </button>
            <button type="button" class="inline-flex flex-col items-center justify-center px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 group">
                <i class="fa-solid fa-dice fa-spin-pulse fa-xl" style="color:#bd0e18;"></i><br>
                <a href="/gardone.html"><span class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">گردونه شانس</span></a>
            </button>
            <button type="button" id="loginButton" class="inline-flex flex-col items-center justify-center px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 group">
                <svg class="w-5 h-5 mb-1 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z"/>
                </svg>
                <a id="loginLink" href="/login.html"><span id="loginText" class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">ورود</span></a>
            </button>
            <button type="button" id="registerButton" class="inline-flex flex-col items-center justify-center px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 group">
                <svg class="w-5 h-5 mb-1 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z"/>
                </svg>
                <a id="registerLink" href="/userlogin.html"><span id="registerText" class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">ثبت نام</span></a>
            </button>
        </div>
    </div>

    <!-- محتوای گردونه -->
    <div class="container mx-auto px-4 py-8 text-center">
        <h1 class="text-3xl font-bold mb-8">گردونه شانس</h1>
        <div id="authMessage" class="hidden text-red-600 text-xl mb-6">
            برای استفاده از چرخونه باید وارد شوید.
            <a href="/login.html" class="underline text-blue-600">ورود</a>
        </div>
        <div id="wheelSection" class="hidden">
            <p id="balance" class="text-lg mb-4">اعتبار شما: <span id="balanceAmount">0</span> تومان</p>
            <div class="flex justify-center mb-6">
                <canvas id="wheel" width="400" height="400"></canvas>
            </div>
            <button id="spinButton" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300" disabled>بچرخ!</button>
            <p id="result" class="mt-6 text-xl font-semibold"></p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const resultText = document.getElementById('result');
        const balanceText = document.getElementById('balanceAmount');
        const wheelSection = document.getElementById('wheelSection');
        const authMessage = document.getElementById('authMessage');
        const loginButton = document.getElementById('loginButton');
        const loginLink = document.getElementById('loginLink');
        const loginText = document.getElementById('loginText');
        const registerButton = document.getElementById('registerButton');
        const registerLink = document.getElementById('registerLink');
        const registerText = document.getElementById('registerText');

        const prizes = [
            { name: 'اکانت فول مگس', color: 'orange' },
            { name: 'کد تخفیف 30%', color: '#10B981' },
            { name: 'پنچ هزار سیپی رایگان', color: '#EF4444' },
            { name: 'شرکت در دور دوم', color: '#3B82F6' },
            { name: 'پوچ', color: 'pink' },
        ];

        // تنظیم جایزه ثابت (0: پوچ, 1: تخفیف, 3: دور دوم)
        const fixedPrizeIndex = 0;

        const SPIN_COST = 2000; // هزینه هر چرخش

        // بررسی وضعیت کاربر
        async function updateNav() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    loginText.textContent = user.username;
                    loginLink.href = '/profile.html';
                    registerButton.classList.add('hidden');
                } else {
                    loginText.textContent = 'ورود';
                    loginLink.href = '/login.html';
                    registerText.textContent = 'ثبت نام';
                    registerLink.href = '/userlogin.html';
                    registerButton.classList.remove('hidden');
                }
            } catch {
                loginText.textContent = 'ورود';
                loginLink.href = '/login.html';
                registerText.textContent = 'ثبت نام';
                registerLink.href = '/userlogin.html';
                registerButton.classList.remove('hidden');
            }
        }

        // بررسی وضعیت ورود کاربر
        async function isUserLoggedIn() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                return response.ok;
            } catch {
                return false;
            }
        }

        // دریافت اطلاعات کاربر
        async function getCurrentUser() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (!response.ok) return null;
                return await response.json();
            } catch {
                return null;
            }
        }

        // به‌روزرسانی اعتبار کاربر
        async function updateUserBalance(newBalance) {
            try {
                const response = await fetch('/api/user', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ balance: newBalance }),
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('خطا در به‌روزرسانی');
                const user = await response.json();
                balanceText.textContent = user.balance;
                return user;
            } catch {
                return null;
            }
        }

        // بررسی و نمایش بخش مناسب
        async function initializePage() {
            if (!(await isUserLoggedIn())) {
                authMessage.classList.remove('hidden');
                wheelSection.classList.add('hidden');
                return;
            }
            authMessage.classList.add('hidden');
            wheelSection.classList.remove('hidden');
            currentUser = await getCurrentUser();
            if (currentUser) {
                balanceText.textContent = currentUser.balance;
                if (currentUser.balance >= SPIN_COST) {
                    spinButton.disabled = false;
                }
            }
        }

        let currentUser = null;
        const arc = Math.PI / (prizes.length / 2);
        let startAngle = 0;
        let spinAngle = 0;
        let isSpinning = false;

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = canvas.width / 2 - 10;

            prizes.forEach((prize, index) => {
                const angle = startAngle + index * arc;
                ctx.fillStyle = prize.color;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, angle, angle + arc);
                ctx.lineTo(centerX, centerY);
                ctx.fill();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle + arc / 2);
                ctx.fillStyle = '#fff';
                ctx.font = '16px Vazirmatn';
                ctx.textAlign = 'right';
                ctx.fillText(prize.name, radius - 20, 0);
                ctx.restore();
            });

            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(centerX, 10);
            ctx.lineTo(centerX - 15, 40);
            ctx.lineTo(centerX + 15, 40);
            ctx.fill();
        }

        async function spinWheel() {
            if (isSpinning || !currentUser) return;

            if (currentUser.balance < SPIN_COST) {
                resultText.textContent = 'برای شارژ چرخونه به ادمین پیام دهید';
                spinButton.disabled = true;
                return;
            }

            isSpinning = true;
            spinButton.disabled = true;
            resultText.textContent = '';

            // کم کردن هزینه چرخش
            currentUser = await updateUserBalance(currentUser.balance - SPIN_COST);
            if (!currentUser) {
                resultText.textContent = 'خطا در به‌روزرسانی اعتبار';
                isSpinning = false;
                return;
            }

            const targetAngle = (fixedPrizeIndex * arc) + (arc / 2);
            const randomSpins = 5 + Math.floor(Math.random() * 3);
            spinAngle = randomSpins * 2 * Math.PI - targetAngle;

            let currentAngle = 0;
            const spinDuration = 4000;
            const startTime = performance.now();

            function animate(time) {
                const elapsed = time - startTime;
                const progress = Math.min(elapsed / spinDuration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);

                startAngle = (spinAngle * easeOut) % (2 * Math.PI);
                drawWheel();

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    const finalPrizeIndex = Math.floor(((2 * Math.PI - startAngle) % (2 * Math.PI)) / arc) % prizes.length;
                    const prizeName = prizes[finalPrizeIndex].name;
                    if (prizeName === 'پوچ') {
                        resultText.textContent = 'پوچ شد';
                    } else {
                        resultText.textContent = 'به ادمین پیام دهید';
                    }
                    if (currentUser.balance >= SPIN_COST) {
                        spinButton.disabled = false;
                    }
                }
            }

            requestAnimationFrame(animate);
        }

        spinButton.addEventListener('click', spinWheel);
        initializePage();
        drawWheel();
        updateNav();
    </script>
</body>
</html>
